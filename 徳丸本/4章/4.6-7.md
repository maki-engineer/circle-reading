## 4.6 セッション管理の不備
- 現在のセッション管理機構
  - クッキーなどにセッションIDという識別子を記憶させ，これをキーとしてサーバー側で情報を記憶する
    - 毎回あなた誰ですか状態にならない
      - セッションとは？
        - https://qiita.com/Yametaro/items/9b65a21940e001554719
### 4.6.1 セッションハイジャックの原因と影響
***POINT | 推測・盗難・強制***
- セッションなりすまし
  - 推測
    - 生成方法が不適切
  - 盗む
    - 生成方法が不適切
    - アプリケーション脆弱性による
    - XSS
      - クロスサイトスクリプティング（XSS）とは？
        - https://www.hitachi-solutions.co.jp/security/sp/words/xss.htm
      - 攻撃手法
        - ユーザー入力部にスクリプトを仕込む
      - 対策
        - 文字列のエスケープ
        - 文字種制限
    - HTTPヘッダ・インジェクション
      - HTTPヘッダに改行が2つ入る（＝空白の行を一つ作る）とそれ以降の文字列はHTTPボディとして扱われる
        - ボディにスクリプトを混入させることができてしまう
      - 攻撃手法
        - クエリパラメータに改行２つとスクリプトを入れ込む
      - 対策
        - HTTPリクエストヘッダで渡されたパラメータのサニタイズ（攻撃に使用される文字列を無効化）
        - サニタイズができない場合＝＞FireWallの利用
    - プラットフォーム脆弱性
      - PHP，ブラウザにある潜在的な問題
    - URLでのセッション保持による
  - 強制
    - セッションIDの固定化攻撃
      - 悪人のセッションIDをわざと使わせて，その人の秘密情報を引き出させた後でそれを悪用する -> p.67
### 4.6.2 推測可能なセッションID
- 対策
  - 自作しない
    - 実績のある言語やミドルウェアが提供するセッション管理機構を使用する
- 攻撃手法
  - セッションIDをいっぱい集める
  - 規則性の仮説を立てる
  - 推測する
- 保険的な対策
  - パスワードを再入力させる
    - セッションからパスワードを取得することはできない
### 4.6.3 URL埋め込みのセッションID
- RefererによりセッションIDが漏洩
  - Refererとは？
    - サイト訪問したユーザーが1つ前に閲覧したWebサイト
  - 漏洩する条件
    - URL埋め込みのセッションIDを使える
    - 外部サイトへのリンクがある　OR　リンクを作成者が作成できる（Webメールや掲示板など）
- 対策
  - URL埋め込みのセッションIDを禁止する設定・実装をする
  - セッションIDをクッキーに保存する
### 4.6.4 セッションIDの固定化
- 攻撃手法
  - 悪人のセッションIDを被害者にわざと使わせて，その人の秘密情報を引き出させた後で，それを悪用する -> p.67
- 対策
  - ログイン時にセッションIDを変更する
    - ログイン自体は被害者が行うため，その時に新しいセッションIDを持たせればいい
    - 仕様上変更できない場合
      - トークンを用いる
        - ログイン時にトークンを生成し，クッキーとセッション変数の両方に記憶させる
          - トークンが外部に出力されるのはログイン時のクッキー生成時のみで，攻撃者に盗む・強制するすべはない
- セッションIDをクッキーに保存していても固定化される可能性がある
  - クッキーモンスターバグ
    - 古いブラウザでは`*.co.jp`ドメインのクッキーが作れてしまう問題
    - 都道府県型JPドメイン名や地域型JPドメイン名もこのバグが発生しやすい
  - XSS
  - HTTPヘッダ・インジェクション
  - プロキシツールを用いたクッキーの改変
    - 通信路上でクッキーを変えられてしまう
      - HTTPのクッキーはHTTPSでも有効なので，通信の暗号化が意味をなさない
- ログイン前のセッションIDの固定化攻撃に対する対策
  - 完全に対策することは困難
  - 原則，ログイン前にセッション管理機構は使わない
    - hiddenパラメータで値を引きまわすのが現実的
    - ECサイトのショッピングカート機能など，どうしても使わなきゃいけない時
      - 秘密情報をセッション変数にセットするたびにセッションIDを変更する
        - 変更したセッションIDをブラウザが受信できなかった場合，セッションが維持できなくなるという副作用がある
- まとめ
  - セッション管理はセキュリティの要
    - 対策
      - セッション管理機構は自作しない
      - クッキーにセッションIDを保存する
      - 認証成功時にセッションIDを変更する
      - 認証前にセッション変数に秘密情報を保存しない
## 4.7 リダイレクト処理にまつわる脆弱性
- オープンリダイレクト脆弱性
- HTTPヘッダ・インジェクション脆弱性
### 4.7.1 オープンリダイレクト
- 任意のドメインにリダイレクトできる脆弱性
  - 利用者が知らないうちに別ドメインに遷移する場合，フィッシング詐欺に悪用される
    - フィッシングとは？
      - 著名なサイトなどを偽装したサイトに利用者を誘導し，個人情報などを入力させる
- 対策
  - リダイレクト先のURLを固定にする
    - アプリの性質上可変にしなければならない場合
      - リダイレクト先のURLを直接指定せず番号指定にする
        - 番号とURLの対応表は外部からは見えない場所（DBなど）で管理する
      - リダイレクト先を許可されたドメインのみに制限する
        - 正規表現などでチェックする
          - チェックを自身で実装する必要があるため落とし穴が多い
- 保険的な対策
  - クッションページ
    - 別ドメインに直接リンクせず，別ドメインへ遷移することを利用者に告知するページを挟む
      - フィッシングの抑止
### 4.7.2 HTTPヘッダ・インジェクション
***POINT | 通信もテキストベース***
- リダイレクトやクッキー発行など，外部からのパラメータをもとにHTTPレスポンスヘッダを出力する際に発生
- 原因
  - レスポンスヘッダにおいて改行に特別な意味があるにもかかわらず，外部から指定された改行をそのまま出力してしまうこと
![](https://storage.googleapis.com/zenn-user-upload/790bcc41f842-20230416.png)
- 影響
  - 任意のクッキーの生成
  - 任意のURLへのリダイレクト
  - 表示内容の改変
  - 任意のJS実行によるXSSと同様の被害
- 対策
  - 外部からのパラメータをHTTPレスポンスヘッダとして出力しない（設計段階で検討）
    - ex.
      - リダイレクト
        - リダイレクト先のURLを直接指定せずに，固定にする，もしくは番号で指定することで解消
      - クッキー生成
        - アプリケーション開発ツールが提供するセッション変数を使ってURLを受け渡すことで解消
  - ヘッダ出力用ライブラリやAPIを利用する（自作しない）　AND　ヘッダ中に改行コードが含まれていないかチェックする
    - どちらか一方ではだめ
      - ライブラリやAPIにも完全に脆弱性対策されていないものがある
### 4.7.3 リダイレクト処理にまつわる脆弱性のまとめ
- リダイレクト処理はできるだけ専用のAPI（ライブラリ関数）を使用する
- リダイレクト先を固定（推奨）　OR　外部から指定するリダイレクト先のURLの文字種とドメイン名のチェック
