## 4.12 (308p) ファイルのアップロードにまつわる問題
### 4.12.1 ファイルアップロードの問題の概要
#### ローカル上にあったファイルや画像などをサーバーにアップロードしてたくさんの人と共有したりするのに使うアップローダーに対する攻撃は4種類
- アップロード機能に対するDoS攻撃
- アップロードされたファイルをサーバー上のスクリプトとして実行する攻撃
- 仕掛けを含むファイルを利用者にダウンロードさせる攻撃
- 閲覧権限のないファイルのダウンロード

#### アップロード機能に対するDoS攻撃
- 影響

  ブラウザの応答速度が低下したり、サーバーが停止してしまうこともある。(例：田代砲)
- 対策

  アップロードされるファイルの容量を制限したり、リクエストボディのサイズを絞るのが有効。
  - 何故ファイルの容量を制限することによって防げるのか

    Dos攻撃の代表的な攻撃例として、Webサイトに対して過剰にアクセスをすることが挙げられるが、膨大な量のファイルをアップロードしてWebサイトの応答速度を低下させるのもDos攻撃に入る。

  また、画像もアップロードできる場合、画像のサイズや色数の上限値を設定したり、CPU負荷の高い処理が含まれる場合は、CPUの使用時間や実行時間を見積もって、それに関連するパラメータを制限するのも大事。
  - CPU負荷の高い処理を特定する方法として、New Relicを利用してボトルネックになっているロジックを特定する方法が有効。

#### アップロードされたファイルをサーバー上のスクリプトとして実行する攻撃

  - 概要

    例えばアップロードできるファイルにphpファイルなども含まれていると、そのphpファイルなどを使って、故意にスクリプトを実行させ、情報漏洩させたり他にアップロードされているファイルの内容を改ざんすることができてしまったりする。

  - 対策

    phpファイルなどがアップロードされた場合は、拡張子をカスタマイズ (.phtmlなど) してしまうか、アップロードされた拡張子の言語の処理自体を制御するのが有効。

#### 仕掛けを含むファイルを利用者にダウンロードさせる攻撃

  - 概要

    仕掛けが含まれたpdfファイルなどをアップロードし、サーバー上にいるときは悪さしないが、別の人がそのファイルを閲覧したりした瞬間にマルウェアに感染したりする。
    対策については、8章にあるマルウェア対策の部分を参照。

  - トリック

    例えばjsファイルをダウンロードをした時にJavaScriptが実行されるのは、アップロードしたファイルをサーバー上に「これはHTMLファイルですよ」と騙す仕掛けになっている。

    また、pdfファイルに関しては、Adobe Acrobat Readerに備わっているFormCalcというスクリプト言語がサーバ上で実行されてしまうリスクがある。

    そして、マルウェア感染によって被害がでた場合、仕掛けを含んだファイルをアップロードした側ももちろん悪いが、そのアップローダーを運営している側も責任を問われる可能性があるため、Webサイトの性質によっては、きちんとマルウェア感染の対策をすること。

#### 閲覧権限のないファイルのダウンロード

  - 原因

    権限をつける必要のあるファイルに適切な権限をつけることがほとんど。この攻撃の詳細については、5章にある認可の部分を参照。

### 4.12.2 アップロードファイルによるサーバー側スクリプト実行

  - 概要

    前述したように、スクリプトファイルがアップロードされて実行されると、情報漏洩させたり他にアップロードされているファイルの内容を改ざんすることができてしまったりするが、それ以外の影響としては以下が挙げられる。
    - 外部へのメールの送信
    - 別のサーバーへ攻撃 (踏み台攻撃)
    - サーバー上での暗号通貨の採掘 (マイニング)

  - 攻撃例

    ```
    <pre>
    <?php
      system('/bin/cat /etc/passwd');
    ?>
    </pre>
    ```

    上記のスクリプトファイルは、catコマンドを使って、 `/etc/passwd` の内容を表示するというもの。
    例えば画像をアップロードするアップローダーにこのスクリプトファイルをアップロードすると、画像ではないため、リンクと×印で表示される。そしてそのリンクをクリックすると、 `/etc/passwd` の内容がサーバー上で表示される。

  - 対策

    こちらも先述したように、phpファイルなどがアップロードされた場合は、拡張子をカスタマイズ (.phtmlなど) してしまうか、アップロードされた拡張子の言語の処理自体を制御するのが有効。

    - 拡張子をチェックする際の注意点

      スクリプトファイルがアップロードされるのを防ぐ方法のもう1つとして、拡張子のチェックが挙げられる。 ( jpg、png、gif 拡張子しか受け付けないよというような処理)<br>この拡張子のチェックももちろん有効だが、Apacheの設定によっては、多重拡張子によって、 .png なのにPHPの処理が実行されてしまう危険性もあるため、拡張子のチェックのみというのは、なるべく避けるべき。

      また、SSIという機能を使うと、HTMLからインクルートしたファイルをコマンドとして実行することが出来る。通常SSIを使う場合のHTMLの拡張子は .shtml だが、設定をすることによって .html でも使えるようになるので、 .html のファイルもスクリプトファイルとして扱う必要があることに注意。

## 4.13 (335p) インクルードにまつわる問題