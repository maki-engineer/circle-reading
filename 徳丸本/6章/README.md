# 6章
## 6.1 (525p) 文字コードとセキュリティの概要
### 文字コードとは
文字コードは次の2つの概念を合わせたもの。
- 文字集合 (6.2で説明)
- 文字エンコーディング (6.3で説明)

Webアプリケーション上で文字コードを指定する箇所はたくさんある。
- 入力の場面
  - ブラウザ → HTTPリクエスト
- 処理の場面
  - アプリケーションの処理
  - スクリプトファイル
- 出力の場面
  - HTTPレスポンス → HTMLブラウザ表示
  - DB (SQL)
  - ファイル
  - メール
  - 外部コマンド


## 6.2 (526p) 文字集合
### 文字集合とは

### 異なる文字が同じコードに割り当てられる問題
前述したように、文字の符号が同じでも、文字集合によって割り当てられている文字が異なる場合がある。セキュリティ上問題になりやすい文字としては「\」（バックスラッシュ）と「¥」（円記号）。<br>ISO-8859-1およびUnicodeでは、0xA5の場所に円記号「¥」が割り当てられているが、日本では歴史的にバックスラッシュの位置0x5Cに円記号「¥」を割り当てていた。関係としては下記の表の感じ。

|  文字集合  |  0x5C  |  0xA5  |
| ---------- | ------ | ------ |
|  TD        |  TD    |  TD    |
|  TD        |  TD    |  TD    |

### 文字集合の扱いが原因で起こる脆弱性
unicodeの円記号「¥」（U+00A5）をJIS系の文字集合に変換すると、処理系によっては円記号という意味を保存するために0x5C（JIS X0201の円記号）に変換する場合がある。この0x5C（バックスラッシュに該当するコード）のエスケープが必要な場合、処理の順序によってはエスケープ処理が抜けてしまい、脆弱性の原因になる。<br>バックスラッシュは、SQL文字列リテラルなどのエスケープ処理の対象となる文字について、円記号「¥」（U+00A5）の状態でエスケープ処理が行われた後でバックスラッシュ「\」に変換されると、エスケープ処理をすり抜けることになる。

## 6.3 (529p) 文字エンコーディング

## 6.4 (540p) 文字コードによる脆弱性の発生要因まとめ
### 文字エンコーディングとして不正なバイト列による脆弱性
文字エンコーディングとして不正なバイト列の代表例は、半端な先行バイトとUTF-8の非最短形式。UTF-8の非最短形式の扱いが原因となった脆弱性として、IISのMS00-57や、Tomcatのディレクトリ・トラバーサル脆弱性CVE-2008-2938がある。MS00-057は、2001年に猛威をふるったNimbaワームが悪用した脆弱性の1つ。

### 文字エンコーディングの扱いの不備による脆弱性
文字エンコーディングに対するバグについては、前述の「5C」問題が代表例。海外で開発されたソフトウェアの中には、マルチバイト文字の処理が考慮されていない、あるいは不完全な場合があり、「5C」問題のような脆弱性が存在する場合がある。また、UTF-7という文字エンコーディングを悪用したXSS攻撃手法があり、これも文字エンコーディングの取り扱い不備で発生する脆弱性。

#### 「5C」問題とは
2バイト文字の2バイト目の値が「5C」である文字を正しく解釈できないアプリで発生する現象のこと。原因としては、2バイト目の「5C」を「\」と解釈してしまうから。よく間違って解釈してしまう単語としては、「機能」、「性能」、「ソース」、「表示」などが挙げられる。

### 文字集合の変更に起因する脆弱性
例えばWindowsのコマンドプロンプト上やVS Code上で「￥」と打とうとすると、「\」に変換されるが、これが文字集合の変更に起因する脆弱性。
この脆弱性が原因で新たに発生してしまう脆弱性としては、4.4章で紹介したJVN#59748723 (http://jvn.jp/jp/JVN59748723/index.html) がある。

## 6.5 (541p) 文字コードを正しく扱うために
文字コードを正しく扱うためのポイントは4つ
- アプリケーション全体を通して文字集合を統一する
- 入力時に不正な文字エンコーディングをエラーにする
- 処理の中で文字エンコーディングを正しく扱う
- 出力時に文字エンコーディングを正しく指定する

### アプリケーション全体を通して文字集合を統一する

### 入力時に不正な文字エンコーディングをエラーにする

### 処理の中で文字エンコーディングを正しく扱う

### 出力時に文字エンコーディングを正しく指定する

### その他の対策

## 6.6 (546p) まとめ
Webアプリケーションを開発している際に、文字化けが起こるのはあるあるの1つだが、文字化けが起こるということは、文字コードの適切な設定や処理ができていないことを意味するため、それが脆弱性と繋がる。<br><br>そのため、文字コードの扱いに起因する脆弱性問題の取り組みとして、まずは文字化けをなくす対策をするのがおすすめ。<br>具体的には
- 不正な文字エンコーディングではエラーになるか代替文字 (U+FFFD) に変換されること
- 「表」や「ソ」、「能」などが正しく登録・表示されること
- 「尾骶骨テスト」と「つちよしテスト」をクリアすること
  - 尾骶骨テストとつちよしテストとは
    - 文字通りWeb上に「尾骶骨」や「𠮷 (つちよし) 」と正しく表示されるかテストする方法。<br>「骶」と「𠮷」という文字はShift_JIS、EUC-JPでは表現できない文字のため、Unicodeに変換することができているか簡単にテストすることができる。

などが挙げられる

### 文字コードの脆弱性を利用した攻撃の代表であるNimbaワームによるMS00-057について
- Nimbaワームとは

  Webを閲覧したり、メールをプレビューしたり、.docファイルを開いたりしただけで感染し、踏み台攻撃によって急激に感染を広げてしまう非常に感染力の強いウィルス。感染の過程でネットワークに過大な負荷を与える。

- 対策方法
  - システムをネットワークから切り離し、ウィルス対策ソフトを使ってNimbaワームの検出と駆除を行う。完全に駆除しきれない場合は、システムの再インストールが必要。
  - Internet Explorerを利用している場合は、IE 5.01 SP2、IE 5.5 SP2、IE 6.0のいずれかにバージョンアップ。<br>IISはMS01-044のセキュリティ・パッチを適用。

- Nimbaワームに関する情報 (対処方法など)
  - 「マイクロソフト――Nimda ワームに関する情報」<br>http://www.microsoft.com/japan/technet/security/alerts/nimda.mspx
  - 「IPA――新種ウイルス「W32/Nimda」に関する情報」<br>http://www.ipa.go.jp/security/topics/newvirus/nimda.html

### 対策のまとめ
- アプリケーション全体を通して文字集合をUnicodeで統一する
- 入力時に不正な文字エンコーディングをエラーにする
- 処理の中で文字エンコーディングを正しく扱う
- 出力時に文字エンコーディングを正しく指定する

### 参考文献
- 『プログラマのための文字コード技術入門』 (https://amzn.to/3Lugpeb)
- 『電脳社会の日本語』 (https://amzn.to/3Apv1VI)