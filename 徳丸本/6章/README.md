# 6章
## 6.1 (525p) 文字コードとセキュリティの概要
### 文字コードとは
文字コードは次の2つの概念を合わせたもの。
- 文字集合 (6.2で説明)
- 文字エンコーディング (6.3で説明)

Webアプリケーション上で文字コードを指定する箇所はたくさんある。
- 入力の場面
  - ブラウザ → HTTPリクエスト
- 処理の場面
  - アプリケーションの処理
  - スクリプトファイル
- 出力の場面
  - HTTPレスポンス → HTMLブラウザ表示
  - DB (SQL)
  - ファイル
  - メール
  - 外部コマンド


## 6.2 (526p) 文字集合
まず最初に、文字集合とは、文字通り文字の集合のこと。アルファベットで出来た文字や、数字で出来た文字などは文字集合。コンピュータで文字集合を扱う場合は、単に文字を集めただけでは取り扱い上不便なため、各文字に符号（番号）をつけて識別する。厳密には、符号をつけた文字集合のことを符号化文字集合と呼ぶ。

### 異なる文字が同じコードに割り当てられる問題
前述したように、文字の符号が同じでも、文字集合によって割り当てられている文字が異なる場合がある。セキュリティ上問題になりやすい文字としては「\」（バックスラッシュ）と「¥」（円記号）。<br>ISO-8859-1およびUnicodeでは、0xA5の場所に円記号「¥」が割り当てられているが、日本では歴史的にバックスラッシュの位置0x5Cに円記号「¥」を割り当てていた。関係としては下記の表の感じ。

|  文字集合    |  0x5C  |  0xA5  |
| ------------ | ------ | ------ |
|  ASCII       |  \     |  %     |
|  JIS X 0201  |  ¥     |  .     |
|  ISO-8859-1  |  \     |  ¥     |
|  Unicode     |  \     |  ¥     |

### 文字集合の扱いが原因で起こる脆弱性
unicodeの円記号「¥」（U+00A5）をJIS系の文字集合に変換すると、処理系によっては円記号という意味を保存するために0x5C（JIS X0201の円記号）に変換する場合がある。この0x5C（バックスラッシュに該当するコード）のエスケープが必要な場合、処理の順序によってはエスケープ処理が抜けてしまい、脆弱性の原因になる。<br>バックスラッシュは、SQL文字列リテラルなどのエスケープ処理の対象となる文字について、円記号「¥」（U+00A5）の状態でエスケープ処理が行われた後でバックスラッシュ「\」に変換されると、エスケープ処理をすり抜けることになる。

## 6.3 (529p) 文字エンコーディング

## 6.4 (540p) 文字コードによる脆弱性の発生要因まとめ
### 文字エンコーディングとして不正なバイト列による脆弱性
文字エンコーディングとして不正なバイト列の代表例は、半端な先行バイトとUTF-8の非最短形式。UTF-8の非最短形式の扱いが原因となった脆弱性として、IISのMS00-57や、Tomcatのディレクトリ・トラバーサル脆弱性CVE-2008-2938がある。MS00-057は、2001年に猛威をふるったNimbaワームが悪用した脆弱性の1つ。

### 文字エンコーディングの扱いの不備による脆弱性
文字エンコーディングに対するバグについては、前述の「5C」問題が代表例。海外で開発されたソフトウェアの中には、マルチバイト文字の処理が考慮されていない、あるいは不完全な場合があり、「5C」問題のような脆弱性が存在する場合がある。また、UTF-7という文字エンコーディングを悪用したXSS攻撃手法があり、これも文字エンコーディングの取り扱い不備で発生する脆弱性。

#### 「5C」問題とは
2バイト文字の2バイト目の値が「5C」である文字を正しく解釈できないアプリで発生する現象のこと。原因としては、2バイト目の「5C」を「\」と解釈してしまうから。よく間違って解釈してしまう単語としては、「機能」、「性能」、「ソース」、「表示」などが挙げられる。

### 文字集合の変更に起因する脆弱性
例えばWindowsのコマンドプロンプト上やVS Code上で「￥」と打とうとすると、「\」に変換されるが、これが文字集合の変更に起因する脆弱性。
この脆弱性が原因で新たに発生してしまう脆弱性としては、4.4章で紹介したJVN#59748723 (http://jvn.jp/jp/JVN59748723/index.html) がある。

## 6.5 (541p) 文字コードを正しく扱うために
文字コードを正しく扱うためのポイントは4つ
- アプリケーション全体を通して文字集合を統一する
- 入力時に不正な文字エンコーディングをエラーにする
- 処理の中で文字エンコーディングを正しく扱う
- 出力時に文字エンコーディングを正しく指定する

### アプリケーション全体を通して文字集合を統一する
文字集合を変更すると、変更先の文字集合で扱えない文字が化けてしまう可能性があるため。

### 入力時に不正な文字エンコーディングをエラーにする
文字エンコーディングが正しいことは処理系が正しい処理をするための前提条件と考えられるため。<br>現在Webアプリケーション開発に用いられる言語の中で、JavaとASP.NET（C#またはVB.NET）の場合は、入力時に文字エンコーディングの変換が入るため、その過程で不正な文字エンコーディングはチェックされ、代替文字という特殊な文字に変換される。<br>Perlの場合は、decode関数による内部形式への変換時に不正な文字エンコーディングは代替文字に変換される。<br>PHPの場合は、文字エンコーディングが自動的にチェックされないため、mb_check_encodeing関数により明示的に文字エンコーディングをチェックする。

### 処理の中で文字エンコーディングを正しく扱う
以下の方法で、文字エンコーディングを正しく扱う
- マルチバイト文字に対応した処理系・関数のみを使う

  文字コードを正しく扱うためには、マルチバイト対等の処理系を用いる必要がある。Java、.NET、Perlを使う場合は問題ないが、PHPは言語処理系としてはマルチバイト文字に対応していないので、以下に従う必要がある。
  - ソースコードはUTF-8で保存する
  - php.iniのdefault_charsetまたはmbstring.internal_encodingをUTF-8と設定する
  - 文字列処理は原則としてmbstring系の関数を用いる（日本語を想定していない文字列データも）
- 関数の引数として文字エンコーディングを明示する

  mbstring系の関数については、php.iniのmbstring.internal_encodingがデフォルト値となる文字エンコーディング指定は省略可能。一方、htmlspecialchars関数などmbstring.internal_encodingがデフォルト値とならない関数は、文字エンコーディングを必ず指定する必要があるが、PHP5.6以降ではphp.iniのdefault_charsetをmbstring.internal_encodingの代わりに設定すべきとされている。

#### htmlspecialchars関数の文字エンコーディング指定は必須
数年前までは、PHPの入門書などで、「htmlspecialchars関数の文字エンコーディング指定は省略していい」と書かれていることが多かったが、これは間違い。古いバージョンのhtmlspecialchars関数の文字エンコーディングチェックが十分でなかったために広まった誤解の可能性が高い。最新バージョンのhtmlspecialchars関数は文字エンコーディングのチェックを厳密に行うため、正しい文字エンコーディング指定により、安全性が高まる。

### 出力時に文字エンコーディングを正しく指定する
出力時の文字エンコーディング指定として、以下を実施する。
- HTTPレスポンスヘッダのContent-Typeで文字エンコーディングを正しく指定する

  HTTPレスポンスのContent-Typeヘッダにより文字エンコーディングを正しく指定していないと、ブラウザにコンテンツの文字エンコーディングをUTF-7と誤認させる方法によるXSS攻撃が可能になる場合がある。正しく指定するとは、ブラウザが理解できる文字エンコーディングを指定するということ。文字エンコーディングの選択については、HTML5の文書の場合はUTF-8を使うことが要求されている。
  - UTF-8
  - Shift_JIS（携帯電話向けWebサイトの場合など特殊な場合のみ）
  - EUC-JP
- データベースの文字エンコーディングを正しく指定する

  データベースの文字エンコーディング指定もセキュリティ上の影響がある。データベースの場合、以下の箇所で、文字エンコーディングの指定が出来る場合がある。（データベースによっては固定の場合もある。）
  - 格納時の文字エンコーディング（列、表、データベースの単位で指定）
  - データベース内の処理に使用する文字エンコーディング
  - データベースエンジンとの接続に用いる文字エンコーディング

  いずれもUnicode系の文字エンコーディング、すなわちUTF-8かUTF-16に設定することを推奨。データベースによっては、UTF-8になっていても3バイト形式まで（基本多言語面; BMP）に対応した文字エンコーディングとなる場合がある。MySQLの場合、文字エンコーディングとして単にutf8と指定すると3バイトまでの形式に対応していて、BMP外の文字を含む完全なUTF-8に対応するには、utf8mb4と指定する必要がある。<br>MySQLのutf8と指定した列に対して、BMP外の文字を登録しようとすると、その文字以降が切り詰められたり、文字化けが発生する場合がある。これは見つけにくいバグや脆弱性の原因になる。この問題を避ける簡便な方法は、データベースやテーブル、列の文字エンコーディングとしてutf8mb4を指定すること。どうしてもutf8を指定しなければならない場合は、入力値検証により、UTF-8の4バイトとなる文字が入っていないことを確認する。
- その他、文字エンコーディングの指定が必要な箇所は漏れなく指定する

  使用する言語やライブラリによっても異なるが、ファイル入出力や電子メールの送信の際にも文字エンコーディングが指定可能な場合がある。使用する文字エンコーディングを確認して、必要な場合は忘れずに文字エンコーディングを指定する。

### その他の対策：文字エンコーディングの自動判定を避ける
言語によっては、HTTPリクエストの文字エンコーディングを自動判定する機能がある（PHP、Java、Perlなど）。しかし、文字エンコーディングの自動判定は以下の理由で避けるべき。
- Shift_JISに含まれる文字だけが入力されるという想定のアプリケーションに、Unicode固有のU+00A5が混入し、エスケープ処理が終わった後でShift_JISに変換された際に0x5C（バックスラッシュ）に変換されることで脆弱性の原因になる。
- 文字エンコーディングの自動判定は完全ではないため、判定の間違いの結果、文字が化ける場合がある。

## 6.6 (546p) まとめ
Webアプリケーションを開発している際に、文字化けが起こるのはあるあるの1つだが、文字化けが起こるということは、文字コードの適切な設定や処理ができていないことを意味するため、それが脆弱性と繋がる。<br><br>そのため、文字コードの扱いに起因する脆弱性問題の取り組みとして、まずは文字化けをなくす対策をするのがおすすめ。<br>具体的には
- 不正な文字エンコーディングではエラーになるか代替文字 (U+FFFD) に変換されること
- 「表」や「ソ」、「能」などが正しく登録・表示されること
- 「尾骶骨テスト」と「つちよしテスト」をクリアすること
  - 尾骶骨テストとつちよしテストとは
    - 文字通りWeb上に「尾骶骨」や「𠮷 (つちよし) 」と正しく表示されるかテストする方法。<br>「骶」と「𠮷」という文字はShift_JIS、EUC-JPでは表現できない文字のため、Unicodeに変換することができているか簡単にテストすることができる。

などが挙げられる

### 文字コードの脆弱性を利用した攻撃の代表であるNimbaワームによるMS00-057について
- Nimbaワームとは

  Webを閲覧したり、メールをプレビューしたり、.docファイルを開いたりしただけで感染し、踏み台攻撃によって急激に感染を広げてしまう非常に感染力の強いウィルス。感染の過程でネットワークに過大な負荷を与える。

- 対策方法
  - システムをネットワークから切り離し、ウィルス対策ソフトを使ってNimbaワームの検出と駆除を行う。完全に駆除しきれない場合は、システムの再インストールが必要。
  - Internet Explorerを利用している場合は、IE 5.01 SP2、IE 5.5 SP2、IE 6.0のいずれかにバージョンアップ。<br>IISはMS01-044のセキュリティ・パッチを適用。

- Nimbaワームに関する情報 (対処方法など)
  - 「マイクロソフト――Nimda ワームに関する情報」<br>http://www.microsoft.com/japan/technet/security/alerts/nimda.mspx
  - 「IPA――新種ウイルス「W32/Nimda」に関する情報」<br>http://www.ipa.go.jp/security/topics/newvirus/nimda.html

### 対策のまとめ
- アプリケーション全体を通して文字集合をUnicodeで統一する
- 入力時に不正な文字エンコーディングをエラーにする
- 処理の中で文字エンコーディングを正しく扱う
- 出力時に文字エンコーディングを正しく指定する

### 参考文献
- 『プログラマのための文字コード技術入門』 (https://amzn.to/3Lugpeb)
- 『電脳社会の日本語』 (https://amzn.to/3Apv1VI)